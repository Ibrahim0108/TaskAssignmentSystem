@model IEnumerable<TaskAssignmentSystem.Models.Workspaces.Workspace>
@using Microsoft.AspNetCore.Http
@{
    ViewData["Title"] = "Workspaces";
    ViewData["ActiveNav"] = "Workspaces";
    var role = Context.Session.GetString("UserRole");
    var isTeacher = role == "Teacher";
    var isStudentOrTeacher = role == "Student" || role == "Teacher";
    var isStudent = role == "Student";
    var isAdmin = role == "Admin";

    string msg;
    if (isAdmin)
    {
        msg = "No workspaces yet.";
    }
    else if (isTeacher)
    {
        msg = "Create one!";
    }
    else // student
    {
        msg = "Ask your teacher for a join code.";
    }
}
<div class="d-flex align-items-center mb-3">
    <h3 class="mb-0">Active Workspaces</h3>
    <div class="ms-auto d-flex gap-2">
        @if (isTeacher)
        {
            <a class="btn btn-primary" href="@Url.Action("Create", "Workspaces")">Create Workspace</a>
        }
        @if (isStudent)
        {
            <a class="btn btn-outline-secondary" href="@Url.Action("Join", "Workspaces")">Join by Code</a>
        }
    </div>
</div>

@if (!Model.Any())
{
    <div class="alert alert-info">@msg</div>
}
else
{
    <div class="card p-3">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr><th>Id</th><th>Name</th><th>Join Code</th><th>Status</th><th>Progress</th><th></th></tr>
                </thead>
                <tbody>
                    @foreach (var w in Model)
                    {
                        <tr>
                            <td>@w.Id</td>
                            <td>@w.Name</td>
                            <td>
                                @if (isTeacher)
                                {
                                    <code>@w.JoinCode</code>
                                }
                                else
                                {
                                    <span class="text-muted">Hidden</span>
                                }
                            </td>

                            <td>
                                @if (w.IsActive)
                                {
                                    <span class="badge bg-success">Active</span>
                                }
                                else
                                {

                                    <span class="badge bg-secondary">Inactive</span>
                                }
                            </td>
                            <td>
                                <div class="progress" style="height:20px; min-width:100px;">
                                    @{
                                        var progressPercent = ViewBag.WorkspaceProgress[w.Id] ?? 0;
                                    }
                                    <div class="progress-bar bg-info" role="progressbar"
                                         style="width:@progressPercent%">
                                        @progressPercent%
                                    </div>
                                </div>

                            </td>
                            <td class="text-end">
                                <a class="btn btn-sm btn-outline-primary" href="@Url.Action("Details", "Workspaces", new { id = w.Id })">Details</a>
                            </td>
                            <td class="text-end">
                                

                                @if (isTeacher || isAdmin)
                                {
                                  

                                    @if (w.IsActive)
                                    {
                                        <form method="post" asp-action="MarkInactive" asp-route-id="@w.Id" style="display:inline;">
                                            <button type="submit" class="btn btn-sm btn-secondary">Inactivate</button>
                                        </form>
                                    }
                                    else
                                    {
                                        <form method="post" asp-action="Restore" asp-route-id="@w.Id" style="display:inline;">
                                            <button type="submit" class="btn btn-sm btn-success">Restore</button>
                                        </form>
                                    }
                                }
                            </td>



                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
