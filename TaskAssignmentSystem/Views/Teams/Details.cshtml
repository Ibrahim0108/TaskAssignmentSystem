@model TaskAssignmentSystem.Models.Teams.Team
@inject TaskAssignmentSystem.Services.Interfaces.IAuthService Auth
@{
    var role = Context.Session.GetString("UserRole");
    var userId = Context.Session.GetInt32("UserId");
}
<div class="container mt-4">
    <div class="d-flex align-items-center">
        <h3 class="mb-0">Team: @Model.Name</h3>
        <div class="ms-auto">
            @if (role == "Teacher" || role == "Admin")
            {
                <a class="btn btn-warning btn-sm me-2" asp-action="Edit" asp-route-id="@Model.Id">Edit</a>
                <form method="post" asp-action="Delete" asp-route-id="@Model.Id" style="display:inline;"
                      data-confirm="true"
                      data-confirm-title="Delete Team"
                      data-confirm-message="Are you sure you want to delete this team?">
                    
                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>
            }
            <a class="btn btn-outline-secondary btn-sm ms-2" href="/Teams/ForWorkspace/@Model.WorkspaceId">Back</a>
        </div>
    </div>

    @if (role == "Teacher")
    {
        <p>Join Code: <code>@Model.JoinCode</code></p>
    }

    <p>
        Leader:
        @{
            var leader = Auth.GetById(Model.LeaderUserId);
        }
        @(leader != null ? leader.FullName : $"User {Model.LeaderUserId}")
    </p>

    <p>
        Status:
        @if (Model.IsSubmitted)
        {
            <span class="badge bg-success">Submitted @Model.SubmittedAt</span>
        }
        else
        {
            <span class="badge bg-warning text-dark">In Progress</span>
        }
    </p>

    <hr />

    <h5>Members</h5>
    @if (Model.TeamMembers == null || !Model.TeamMembers.Any())
    {
        <div class="alert alert-warning">No members yet.</div>
    }
    else
    {
        <ul>
            @foreach (var member in Model.TeamMembers)
            {
                var u = Auth.GetById(member.UserId);

                // skip leader (teacher/admin) if they were set as LeaderUserId but not joined
                if (u != null && member.UserId != Model.LeaderUserId)
                {
                    <li>@u.FullName (@u.Username) - @u.Role</li>
                }
            }
        </ul>

    }

    <h5 class="mt-3">Updates</h5>
    @if (!Model.Updates.Any())
    {
        <div class="alert alert-info">No updates yet.</div>
    }
    else
    {
        <table class="table table-sm">
            <thead><tr><th>When</th><th>By</th><th>Content</th><th>Reviewed</th><th></th></tr></thead>
            <tbody>
                @foreach (var u in Model.Updates.OrderByDescending(x => x.CreatedAt))
                {
                    var user = Auth.GetById(u.UserId);
                    <tr>
                        <td>@u.CreatedAt.ToLocalTime()</td>
                        <td>@(user != null ? user.FullName : $"User {u.UserId}")</td>
                        <td>@u.Content</td>
                        <td>@(u.ReviewedByLeader ? "Yes" : "No")</td>
                        <td>
                            @if (userId == Model.LeaderUserId && !u.ReviewedByLeader)
                            {
                                <form method="post" asp-action="LeaderReview">
                                    <input type="hidden" name="teamId" value="@Model.Id" />
                                    <input type="hidden" name="updateId" value="@u.Id" />
                                    <button class="btn btn-sm btn-outline-success" type="submit">Mark Reviewed</button>
                                </form>
                            }
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    @if (userId != null && Model.TeamMembers.Any(m => m.UserId == userId.Value) && !Model.IsSubmitted)
    {
        <div class="card mt-3">
            <div class="card-body">
                <form method="post" asp-action="AddUpdate"
                      data-confirm="true"
                      data-confirm-title="Add Update"
                      data-confirm-message="Are you sure you want to post this update?">
                    <input type="hidden" name="teamId" value="@Model.Id" />
                    <div class="mb-2">
                        <textarea name="content" class="form-control" rows="2" placeholder="Describe subtask..." required></textarea>
                    </div>

                    <div class="mb-2">
                        <label>Status:</label>
                        <select name="status" class="form-select" required>
                            <option value="NotStarted">Not Started</option>
                            <option value="InProgress">In Progress</option>
                            <option value="Completed">Completed</option>
                            <option value="Blocked">Blocked</option>
                        </select>
                    </div>

                    <button class="btn btn-primary btn-sm" type="submit">Add Update</button>

                </form>
            </div>
        </div>
    }

    @if (userId == Model.LeaderUserId && !Model.IsSubmitted)
    {
        <form class="mt-3" method="post" asp-action="Submit"
              data-confirm="true"
              data-confirm-title="Submit Team"
              data-confirm-message="Are you sure you want to submit the team to the teacher?">
            <input type="hidden" name="teamId" value="@Model.Id" />
            <button class="btn btn-danger" type="submit">Submit To Teacher</button>
        </form>
    }

   
</div>
